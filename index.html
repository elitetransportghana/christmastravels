<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elite Transport â€” Christmas Break Bus Booking</title>
<script src="https://js.paystack.co/v1/inline.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// ---------- Firebase Setup ----------
const firebaseConfig = {
  apiKey: "AIzaSyAemck6mdMNW_sripWUzM8WQjjrmLf69pQ",
  authDomain: "elite-travels.firebaseapp.com",
  projectId: "elite-travels",
  storageBucket: "elite-travels.firebasestorage.app",
  messagingSenderId: "501436168620",
  appId: "1:501436168620:web:f62aa5f9e8e6a4310a2209"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- Variables ----------
const ROUTE_PRICES = { "Accra": 245, "Kumasi": 143, "Sunyani": 143, "Takoradi": 245 };
const seats = {};
const selected = new Set();
const preBooked = { "Accra": [], "Kumasi": [], "Sunyani": [], "Takoradi": [] };

const seatmapEl = document.getElementById("seatmap");
const selectedCountEl = document.getElementById("selectedCount");
const totalEl = document.getElementById("total");
const modal = document.getElementById("modal");
const receiptBody = document.getElementById("receiptBody");

// ---------- Seat Functions ----------
function buildSeats() {
  seatmapEl.innerHTML = "";
  for (let i = 1; i <= 49; i++) {
    seats[i] = seats[i] || { status: "free" };
    const div = document.createElement("div");
    div.className = "seat";
    div.dataset.id = i;
    div.textContent = i;
    div.addEventListener("click", () => {
      if (seats[i].status === "taken") return;
      if (seats[i].status === "selected") { seats[i].status = "free"; selected.delete(i); }
      else { seats[i].status = "selected"; selected.add(i); }
      refreshSeats(); updateSummary();
    });
    seatmapEl.appendChild(div);
    if (i % 3 === 0 && i < 49) {
      const aisle = document.createElement('div'); aisle.className = 'aisle'; seatmapEl.appendChild(aisle);
    }
  }
}

async function refreshSeats() {
  const route = document.getElementById("route").value;
  const date = document.getElementById("date").value;
  let booked = preBooked[route] || [];
  const docId = `${route}_${date}`;
  const docRef = doc(db, "bookings", docId);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) { booked = booked.concat(docSnap.data().seats || []); }
  document.querySelectorAll(".seat").forEach(el => {
    const id = parseInt(el.dataset.id);
    el.classList.remove("selected", "taken");
    if (selected.has(id)) el.classList.add("selected");
    if (booked.includes(id)) el.classList.add("taken");
  });
}

function updateSummary() {
  const route = document.getElementById("route").value;
  const price = ROUTE_PRICES[route];
  selectedCountEl.textContent = selected.size;
  totalEl.textContent = (selected.size * price).toFixed(2);
}

async function saveBooking(name, phone, route, date, seatsArr) {
  const docId = `${route}_${date}`;
  const docRef = doc(db, "bookings", docId);
  const docSnap = await getDoc(docRef);
  let currentSeats = [];
  if (docSnap.exists()) { currentSeats = docSnap.data().seats; }
  const updatedSeats = [...new Set([...currentSeats, ...seatsArr])];
  await setDoc(docRef, { seats: updatedSeats });
  const bookingsCol = collection(db, "passengerBookings");
  await addDoc(bookingsCol, { name, phone, route, date, seats: seatsArr, timestamp: Timestamp.now(), paid: true });
}

// ---------- Event Listeners ----------
document.getElementById("route").addEventListener("change", () => { selected.clear(); refreshSeats(); updateSummary(); });
document.getElementById("date").addEventListener("change", () => { selected.clear(); refreshSeats(); updateSummary(); });

// ---------- Booking & Payment ----------
document.getElementById("book").addEventListener("click", () => {
  const name = document.getElementById("fullname").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const date = document.getElementById("date").value;
  const route = document.getElementById("route").value;

  if (!name || !phone) { alert("Enter name and phone number"); return; }
  if (selected.size === 0) { alert("Select at least one seat"); return; }

  const seatsArr = Array.from(selected);
  const amount = seatsArr.length * ROUTE_PRICES[route] * 100;

  const reference = 'ET' + Math.floor(Math.random() * 1000000000 + 1);
  console.log("Generated Paystack reference:", reference);

  let handler = PaystackPop.setup({
    key: "pk_test_d1cfdee00c5d5743830737d892e4e86705a4d9cd",
    email: phone + "@example.com",
    amount: amount,
    currency: "GHS",
    ref: reference,
    metadata: {
      custom_fields: [
        { display_name: "Full Name", value: name },
        { display_name: "Phone", value: phone },
        { display_name: "Route", value: route },
        { display_name: "Seats", value: seatsArr.join(", ") }
      ]
    },
    callback: function (response) {
      console.log("Paystack callback fired. Reference:", response.reference);

      // ---------- Delay fetch to ensure Paystack registers transaction ----------
      setTimeout(() => {
        fetch("https://shy-bonus-fbab.elitetransportghana.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reference: response.reference })
        })
        .then(res => res.json())
        .then(data => {
          console.log("Verification response from Worker:", data);
          if (data.verified) {
            saveBooking(name, phone, route, date, seatsArr).then(() => {
              const totalPrice = seatsArr.length * ROUTE_PRICES[route];
              receiptBody.innerHTML = `
Elite Transport â€” Booking Receipt
Passenger: ${name}
Phone: ${phone}
Boarding: UDS Campus
Date: ${date}
Route: ${route}
Seats: ${seatsArr.join(", ")}
Total Paid: â‚µ${totalPrice}
              `;
              modal.style.display = "flex";
              selected.clear();
              refreshSeats();
              updateSummary();
            });
          } else {
            alert("Payment could not be verified. Contact support.");
          }
        })
        .catch(err => { console.error(err); alert("Error verifying payment."); });
      }, 1500); // 1.5s delay
    },
    onClose: function () { alert("Payment not completed"); }
  });

  handler.openIframe();
});

// ---------- Initialize ----------
buildSeats(); refreshSeats(); updateSummary();
</script>
</head>
<body>
<!-- HTML content with seatmap, summary, etc. -->
<div class="container-wrapper">
  <div class="container">
    <h1>ðŸŽ„ Elite Transport â€” Christmas Break Bus Booking ðŸŽ„</h1>
    <input type="text" id="fullname" placeholder="Full Name">
    <input type="text" id="phone" placeholder="Phone Number">
    <label>Travel Date</label>
    <select id="date">
      <option value="2025-12-20">20th December</option>
      <option value="2025-12-21">21st December</option>
    </select>
    <label>Route</label>
    <select id="route">
      <option value="Accra">Accra â€” â‚µ240</option>
      <option value="Kumasi">Kumasi â€” â‚µ140</option>
      <option value="Sunyani">Sunyani â€” â‚µ140</option>
      <option value="Takoradi">Takoradi â€” â‚µ240</option>
    </select>
    <div id="seatmap"></div>
    <div class="summary">
      <p>Seats Selected: <span id="selectedCount">0</span></p>
      <p>Total(online charges apply): â‚µ<span id="total">0</span></p>
    </div>
    <button id="book">Pay & Book Now</button>
  </div>
</div>
<div id="modal" class="modal">
  <div class="modal-content">
    <h2>Booking Receipt</h2>
    <pre id="receiptBody"></pre>
    <button id="closeModal">Close</button>
  </div>
</div>
</body>
</html>
